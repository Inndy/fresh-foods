# Hash

Author: Inndy < inndy [dot] tw [at] gmail [dot] com >

Date: 2016/07/18

## 雜湊的其他用途

除了上一週所提到的儲存密碼，雜湊還有其他非常多的作用，如：

- 幫資料分類（data sharding、hash set）
    - 如果 hash function 只是很簡單地把輸入資料除以十，那你就可以把資料分成十堆，分別存在不同的地方
- 檢查資料完整性（下載檔案時，常會附上 sha1 / sha256  hash）
    - 萬一你下載了作業系統的安裝程式，結果安裝到一半告訴你說安裝檔不完整，沒辦法安裝，夠囧吧？
- 保護資料不被竄改（HMAC）
    - 如果你需要把敏感資料存在第三方手上，你需要確保持有你資料的人不會惡意篡改你的資料
- Block Chain
    - BitCoin 相關的技術
- 尋找重複的檔案
    - 想像一下你有一萬個10MB檔案，其中這些資料彼此都具有超過95%的相同內容，大概有幾千個檔案內容是完全一樣的，一個一個抓出來倆倆比較需要花多少時間？

## 資料完整性驗證

如果是透過不穩定的傳輸媒介交換資料，可能會因為雜訊而造成資料的內容毀損或者傳輸了不正確的內容，這時候你可以附上資料的 hash，讓接收端有能力檢查出資料傳輸有誤，甚至具有一定的自我更正能力。

另一種資料完整性的保證，是為了保護資料不被第三人竄改，例如在 A 銀行轉賬，但是網路不通所以 A 銀行給了你一張書面證明，叫你拿去 B 銀行完成轉帳動作，那麼 A, B 銀行要如何確保你不會擅自修改書面證明上的東西？

## Hash-based Messenage Authentication Code (HMAC)

另一個場景，現在的網路服務常常會有會員登入機制，在網頁上的做法常常會在你的 [Cookie](https://zh.wikipedia.org/wiki/Cookie) 中記錄你的身份、會員權限之類的資料，但是 Cookie 可以輕易的修改，要如何確保網站的使用者不會修改自己的 Cookie 偽裝成另一個會員甚至是管理員？至於解決方案之一就是使用 HMAC，對於其他的方法我們之後再談。

概念上來講，HMAC 就是把 data 和一組暗號（secret）一起拿去做 hash，如果有人篡改了資料內容，但是不知道 secret，就會發現 HMAC 和資料不符合，進而防止資料被竄改。

對於 HMAC 的實作細節可以參考 [Wikipedia](https://en.wikipedia.org/wiki/Hash-based_message_authentication_code)


## 針對雜湊密碼的攻擊與防禦

如果我們儲存的是單次 `md5` 或是 `sha1` hash 過後的密碼，那麼可以進行字典檔攻擊以及彩虹表攻擊甚至是暴力破解。

### 字典檔攻擊

準備一串文字組合出可能的密碼，例如：日期、姓名、常用單字、動物... 之類的單字，組合成字典，並且用字典的內容組合出可能的密碼，如：`dog1234`, `cake19920214` ...之類的，逐一猜測，大部分的人設定密碼的習慣會容易被猜中

### 彩虹表攻擊

針對單一的 hash 方式，可以產生 rainbow table，即：`000` 一直到 `ZZZZZZZZZZZZ` 的 hash 結果，想要知道某個 hash 對應的原文，只要使用查表的方式就可以很有效率的還原出原文，像是單層 `md5` 之類的就有很多彩虹表網站可以查詢，而目前的 `md5` 解密網站服務都是採用這種方式進行

### 如何防禦

最簡單的方法叫做 **加鹽** (salt) ，即對於每次 hash 都產生一組亂數資料，與密碼放在一起 hash，如此一來假設密碼至少 12 位，加上 16 位的 hash，你需要產生 28 位長度的彩虹表才能夠還原出一定程度的資料

有效的防禦，就是讓攻擊者的成本變高，所以可以採用 strong hash，讓運算時間變長，如果計算一次 hash 需要 0.3 秒，計算出所有八位英數大小寫組合的密碼 hash 就需要 700 萬年的時間（假設你只用一個 CPU 和一台電腦的狀況下），就算你用一百台電腦同時進行運算，也需要至少 7 萬年的時間才能夠完成整個彩虹表，如此一來就能夠讓攻擊成本過高，讓壞人打消念頭

因此，對於密碼的儲存應該採用：

1. strong hash
2. 加鹽

兩種保護措施，很幸運的，現代密碼 hash 函式庫都幫你做完以上兩件事情，選用 `scrypt`, `bcrypt`, `pbkdf2` 之類的密碼專用 hash 就可以保護好你的會員囉！

## 針對雜湊的攻擊

最著名的問題應該是 [Length Extension Attack](https://en.wikipedia.org/wiki/Length_extension_attack)，這個問題主要是在說，當你知道部分資料以及他的 hash，可以在資料最後面新增任意資料，並且計算出新的 hash 值，這個問題在 `crc32`, `md5`, `sha1`, `sha256` ... 等 hash 上面都存在。

```
hash([xxxxx] [data you know]) == 0x12345678
hash([xxxxx] [data you know] [something brand new]) == extense([something brand new], 0x12345678) == 0x56781234
```

## 加密、編碼、雜湊的差異

- 加密（encrypt）後的內容（ciphertext）可以解密，還原出明文（plaintext），過程中需要秘鑰（key）來保護明文
- 編碼（encode）是指採用不同的方式來表示資料，常見的編碼方式如：base64，對於有經驗的程式設計師或是駭客來說，看一眼馬上就能夠辨識出來編碼方式，並且實作方式基本上是每個人都知道該怎麼進行轉換，解碼後就可以還原出原始資料，過程中沒有秘鑰的存在
- 雜湊（hash）是把資料濃縮，計算出雜湊值（hash value），基本上沒有辦法還原出明文，因為有可能存在多個資料可以算出同一個 hash 的狀況

## 下週預告

- 什麼是資訊安全三要素（CIA）

---

這篇文章以 [CC BY-NC-SA 3.0](https://creativecommons.org/licenses/by-nc-sa/3.0/tw/) 授權釋出
